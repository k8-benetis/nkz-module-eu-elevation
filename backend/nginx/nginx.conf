server {
    listen 80;
    server_name _;
    
    # Root directory where the terrain directories (e.g., uk/12/2048/2048.terrain.gz) are stored
    root /usr/share/nginx/html;

    # Important tuning for high-throughput static serving
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;

    # Security & CORS Headers
    # Required by CesiumJS running on the main application domain
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept" always;

    # Handle preflight OPTIONS requests swiftly
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # Location for Quantized Mesh terrain files
    location / {
        # Enable serving pre-compressed .gz files if they exist on disk
        # When Cesium asks for `.terrain`, Nginx will look for `.terrain.gz` and serve it with Content-Encoding: gzip
        gzip_static on;

        # Force correct Content-Type for Quantized Mesh
        types { 
            application/vnd.quantized-mesh terrain; 
        }

        # Cache heavily (1 week) since terrain rarely changes
        expires 7d;
        add_header Cache-Control "public, no-transform";
        
        # Don't buffer responses to proxy (if acting as one), just stream
        proxy_buffering off;
        
        # Open file cache for extreme performance (caching file descriptors)
        open_file_cache max=10000 inactive=5m;
        open_file_cache_valid 2m;
        open_file_cache_min_uses 1;
        open_file_cache_errors on;
    }

    # Explicit configuration for layer.json (Metadata)
    location ~* layer\.json$ {
        types { 
            application/json json; 
        }
        # Shorter cache for metadata as it might update when new levels are generated
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }
}
